<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Merge Images Smart Grid</title>

<!-- Favicon & PWA icon -->
<link rel="icon" href="ico.png" type="image/png">
<link rel="apple-touch-icon" href="ico.png">
<link rel="manifest" href="manifest.json">

<style>
body {
    font-family: "Segoe UI", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0;
    padding: 20px;
    background: #f0f0f0;
}
h1 { 
    text-align: center; 
    color: #4CAF50; 
    display:flex;
    align-items:center;
}
h1 img { 
    width:32px; 
    height:32px; 
    margin-right:8px; 
}
#preview {
    margin-top: 20px;
    border: 2px solid #4CAF50;
    width: 400px;
    height: 310px;
    object-fit: contain;
}
button {
    font-size: 16px;
    padding: 10px 20px;
    margin: 5px;
    cursor: pointer;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
}
button:hover { background: #45a049; }
input[type=file] { display:none; }
#chooseContainer { display:flex; flex-wrap:wrap; justify-content:center; max-width:420px; }
</style>
</head>
<body>

<h1>
  <img src="h6.png" alt="icon">
  Merge Images Smart Grid
</h1>

<div id="chooseContainer"></div>
<button id="downloadBtn" style="display:none;">ðŸ’¾ Download Merged Image</button>

<canvas id="canvas" width="2250" height="1750" style="display:none;"></canvas>
<img id="preview" alt="Preview of merged image">

<script>
const chooseContainer = document.getElementById('chooseContainer');
const canvas = document.getElementById('canvas');
const preview = document.getElementById('preview');
const downloadBtn = document.getElementById('downloadBtn');
const ctx = canvas.getContext('2d');

const maxImages = 12;
const images = new Array(maxImages).fill(null);
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

// Compute grid: 2 rows if even >=4, otherwise 1 row or ceil(n/2)
function computeGrid(n){
    if(n<4) return {rows:1, cols:n};
    if(n%2===0) return {rows:2, cols:n/2};
    const rows=2, cols=Math.ceil(n/2);
    return {rows, cols};
}

// iOS: 10 separate file inputs
if(isIOS){
    for(let i=0;i<maxImages;i++){
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.id = 'fileInput'+i;

        const btn = document.createElement('button');
        btn.textContent = 'ðŸ“‚ Choose Image '+(i+1);
        btn.addEventListener('click',()=>input.click());

        input.addEventListener('change',()=>{
            const file = input.files[0];
            if(file){
                const img = new Image();
                img.onload = () => { images[i]=img; drawPreview(); };
                img.src = URL.createObjectURL(file);
            }
        });

        chooseContainer.appendChild(btn);
        chooseContainer.appendChild(input);
    }
}else{
    // Android/Desktop: single multiple file input
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.multiple = true;
    input.id = 'fileInputMulti';
    input.style.display='none';

    const btn = document.createElement('button');
    btn.textContent = 'ðŸ“‚ Choose Images (Max 12)';
    btn.addEventListener('click',()=>input.click());

    input.addEventListener('change',()=>{
        const files = Array.from(input.files).slice(0,maxImages);
        files.forEach((file,index)=>{
            const img = new Image();
            img.onload = () => {
                images[index]=img;
                drawPreview();
            };
            img.src = URL.createObjectURL(file);
        });
    });

    chooseContainer.appendChild(btn);
    chooseContainer.appendChild(input);
}

// Draw preview
function drawPreview(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const validImages = images.filter(i=>i!==null);
    const n = validImages.length;
    if(n===0) return;

    const grid = computeGrid(n);
    const rows = grid.rows;
    const cols = grid.cols;
    const cellWidth = canvas.width / cols;
    const cellHeight = canvas.height / rows;

    validImages.forEach((img,index)=>{
        const scale = Math.min(cellWidth / img.width, cellHeight / img.height);
        const w = img.width*scale;
        const h = img.height*scale;
        const x = (index % cols)*cellWidth + (cellWidth - w)/2;
        const y = Math.floor(index/cols)*cellHeight + (cellHeight - h)/2;
        ctx.drawImage(img,x,y,w,h);
    });

    preview.src = canvas.toDataURL("image/jpeg",0.95);
    if(validImages.length>0) downloadBtn.style.display='inline-block';
}

downloadBtn.addEventListener('click',()=>{
    const link = document.createElement('a');
    link.href = canvas.toDataURL("image/jpeg",0.95);
    link.download='merged.jpg';
    link.click();
});
</script>

</body>
</html>
